apiVersion: v1
kind: ConfigMap
metadata:
  name: wazuh-agent-config
  namespace: wazuh
data:
  ossec.conf: |
    <ossec_config>
      <!-- Wazuh Manager Connection -->
      <client>
        <server>
          <address>wazuh-manager.wazuh.svc.cluster.local</address>
          <port>1514</port>
          <protocol>tcp</protocol>
        </server>
        <config-profile>kubernetes</config-profile>
        <notify_time>60</notify_time>
        <time-reconnect>300</time-reconnect>
        <auto_restart>yes</auto_restart>
      </client>

      <!-- File Integrity Monitoring -->
      <syscheck>
        <disabled>no</disabled>
        <frequency>3600</frequency>
        <scan_on_start>yes</scan_on_start>

        <!-- Monitor critical system files -->
        <directories check_all="yes" realtime="yes">/host/etc</directories>
        <directories check_all="yes" realtime="yes">/host/usr/bin</directories>
        <directories check_all="yes" realtime="yes">/host/usr/sbin</directories>
        <directories check_all="yes" realtime="yes">/host/boot</directories>

        <!-- Monitor Kubernetes config -->
        <directories check_all="yes" realtime="yes">/host/etc/kubernetes</directories>
        <directories check_all="yes" realtime="yes">/var/lib/kubelet</directories>

        <!-- Ignore some directories -->
        <ignore>/host/etc/mtab</ignore>
        <ignore>/host/etc/hosts.deny</ignore>
        <ignore>/host/etc/mail/statistics</ignore>
        <ignore>/host/etc/random-seed</ignore>
        <ignore>/host/etc/random.seed</ignore>
        <ignore>/host/etc/adjtime</ignore>
        <ignore>/host/etc/httpd/logs</ignore>
        <ignore>/host/etc/utmpx</ignore>
        <ignore>/host/etc/wtmpx</ignore>
        <ignore>/host/etc/cups/certs</ignore>
        <ignore>/host/etc/dumpdates</ignore>
        <ignore>/host/etc/svc/volatile</ignore>

        <!-- Ignore patterns -->
        <ignore type="sregex">.log$|.swp$</ignore>

        <!-- File types to monitor -->
        <no_diff>/host/etc/ssl/private.key</no_diff>
      </syscheck>

      <!-- Log Analysis -->
      <localfile>
        <log_format>syslog</log_format>
        <location>/var/log/messages</location>
      </localfile>

      <localfile>
        <log_format>syslog</log_format>
        <location>/var/log/secure</location>
      </localfile>

      <localfile>
        <log_format>syslog</log_format>
        <location>/var/log/audit/audit.log</location>
      </localfile>

      <!-- Rootcheck -->
      <rootcheck>
        <disabled>no</disabled>
        <check_files>yes</check_files>
        <check_trojans>yes</check_trojans>
        <check_dev>yes</check_dev>
        <check_sys>yes</check_sys>
        <check_pids>yes</check_pids>
        <check_ports>yes</check_ports>
        <check_if>yes</check_if>
        <frequency>36000</frequency>
        <rootkit_files>/var/ossec/etc/shared/rootkit_files.txt</rootkit_files>
        <rootkit_trojans>/var/ossec/etc/shared/rootkit_trojans.txt</rootkit_trojans>
        <skip_nfs>yes</skip_nfs>
      </rootcheck>

      <!-- Security Configuration Assessment (SCA) -->
      <sca>
        <enabled>yes</enabled>
        <scan_on_start>yes</scan_on_start>
        <interval>12h</interval>
        <skip_nfs>yes</skip_nfs>

        <!-- CIS Kubernetes Benchmark -->
        <policies>
          <policy>cis_kubernetes.yml</policy>
          <policy>cis_docker.yml</policy>
        </policies>
      </sca>

      <!-- Container Security -->
      <wodle name="docker-listener">
        <disabled>no</disabled>
        <interval>10m</interval>
        <attempts>5</attempts>
        <run_on_start>yes</run_on_start>
      </wodle>

      <!-- Vulnerability Detection -->
      <wodle name="vulnerability-detector">
        <disabled>no</disabled>
        <interval>1d</interval>
        <run_on_start>yes</run_on_start>
        <feed name="ubuntu">
          <disabled>no</disabled>
          <update_interval>1h</update_interval>
        </feed>
        <feed name="debian">
          <disabled>no</disabled>
          <update_interval>1h</update_interval>
        </feed>
        <feed name="redhat">
          <disabled>no</disabled>
          <update_interval>1h</update_interval>
        </feed>
        <feed name="alpine">
          <disabled>no</disabled>
          <update_interval>1h</update_interval>
        </feed>
      </wodle>

      <!-- System Inventory -->
      <wodle name="syscollector">
        <disabled>no</disabled>
        <interval>1h</interval>
        <scan_on_start>yes</scan_on_start>
        <hardware>yes</hardware>
        <os>yes</os>
        <network>yes</network>
        <packages>yes</packages>
        <ports all="no">yes</ports>
        <processes>yes</processes>
      </wodle>

      <!-- Active Response (disabled by default for safety) -->
      <active-response>
        <disabled>yes</disabled>
      </active-response>

      <!-- Log all -->
      <logging>
        <log_format>plain</log_format>
      </logging>
    </ossec_config>

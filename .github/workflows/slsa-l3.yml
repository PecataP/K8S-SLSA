name: SLSA L3 Pipeline

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'k8s/deployment.yaml'  # Don't trigger on automated digest updates
  workflow_dispatch: {}

# Prevent concurrent runs on the same branch to avoid provenance conflicts
concurrency:
  group: slsa-l3-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read  # Write needed for automated digest updates
  packages: write
  id-token: write

env:
  IMAGE_NAME: ghcr.io/pecatap/python-slsa-web
  IMAGE_REGISTRY: ghcr.io

jobs:
  # ============================================================================
  # Build and Push Container Image
  # ============================================================================
  build-and-push:
    name: Build and Push Container
    runs-on: self-hosted
    permissions:
      contents: read
      packages: write
      id-token: write  # For keyless signing with Cosign
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-name: ${{ env.IMAGE_NAME }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push container image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./DOCKERFILE
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64
          # Note: Basic provenance, will be replaced by SLSA L3 provenance
          provenance: false
          sbom: true
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.4.0
        with:
          cosign-release: 'v2.2.3'

      - name: Sign container image with Cosign (Keyless)
        env:
          DIGEST: ${{ steps.build.outputs.digest }}
          TAGS: ${{ steps.meta.outputs.tags }}
        run: |
          echo "Signing image with Cosign keyless signing..."
          images=""
          for tag in ${TAGS}; do
            images+="${tag}@${DIGEST} "
          done

          # Sign with keyless (OIDC) - no private key needed!
          cosign sign --yes ${images}

          echo " Image signed successfully with Sigstore!"

      - name: Display build information
        env:
          DIGEST: ${{ steps.build.outputs.digest }}
          TAGS: ${{ steps.meta.outputs.tags }}
        run: |
          echo "### SLSA L3 Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** ${DIGEST}" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:** ${TAGS}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Reference (Use This in K8s)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ env.IMAGE_NAME }}@${DIGEST}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Generate SLSA L3 Provenance
  # ============================================================================
  provenance:
    name: Generate SLSA L3 Provenance
    needs: [build-and-push]
    permissions:
      actions: read
      id-token: write
      packages: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.0.0
    with:
      image: ${{ needs.build-and-push.outputs.image-name }}
      digest: ${{ needs.build-and-push.outputs.image-digest }}
      registry-username: ${{ github.actor }}
    secrets:
      registry-password: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # Verify Image Signature and Provenance
  # ============================================================================
  verify:
    name: Verify Signature and Provenance
    needs: [build-and-push, provenance]
    runs-on: self-hosted
    permissions:
      contents: read
      packages: read

    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.4.0
        with:
          cosign-release: 'v2.2.3'

      - name: Prepare slsa-verifier directory
        run: |
          mkdir -p ~/.slsa/bin
          chmod -R 755 ~/.slsa

      - name: Install slsa-verifier
        uses: slsa-framework/slsa-verifier/actions/installer@v2.5.1

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify image signature with Cosign
        env:
          IMAGE: ${{ needs.build-and-push.outputs.image-name }}
          DIGEST: ${{ needs.build-and-push.outputs.image-digest }}
        run: |
          echo " Verifying image signature..."

          # Verify using keyless verification (OIDC)
          cosign verify \
            --certificate-identity-regexp="https://github.com/${{ github.repository }}/.*" \
            --certificate-oidc-issuer="https://token.actions.githubusercontent.com" \
            "${IMAGE}@${DIGEST}"

          echo "Signature verification successful!"

      - name: Verify SLSA L3 provenance
        env:
          IMAGE: ${{ needs.build-and-push.outputs.image-name }}
          DIGEST: ${{ needs.build-and-push.outputs.image-digest }}
        run: |
          echo "Verifying SLSA L3 provenance..."

          # Verify provenance with slsa-verifier
          slsa-verifier verify-image \
            --source-uri github.com/${{ github.repository }} \
            --source-branch main \
            "${IMAGE}@${DIGEST}"

          echo "SLSA L3 provenance verification successful!"

      - name: Inspect all attestations
        env:
          IMAGE: ${{ needs.build-and-push.outputs.image-name }}
          DIGEST: ${{ needs.build-and-push.outputs.image-digest }}
        run: |
          echo "Inspecting all attestations..."
          cosign tree "${IMAGE}@${DIGEST}"

  # ============================================================================
  # Update Deployment with New Digest
  # ============================================================================
  update-gitops-repo:
    name: Update GitOps Deployment Digest
    needs: [build-and-push, provenance, verify]
    runs-on: ubuntu-latest
    permissions:
      contents: write   # but this is for K8S-SLSA; youâ€™ll use a PAT for K8S-CD

    steps:
      - name: Checkout GitOps repo
        uses: actions/checkout@v4
        with:
          repository: PecataP/K8S-CD
          token: ${{ secrets.GITOPS_PAT }}  # classic personal access token
          path: gitops

      - name: Update deployment.yaml with new digest
        working-directory: gitops
        env:
          IMAGE_NAME: ${{ needs.build-and-push.outputs.image-name }}
          DIGEST: ${{ needs.build-and-push.outputs.image-digest }}
        run: |
          sed -i "s|image: ${IMAGE_NAME}.*|image: ${IMAGE_NAME}@${DIGEST}|g" deployment.yaml
          git diff

      - name: Commit and push
        working-directory: gitops
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git add deployment.yaml
          git commit -m "chore: update deployment digest to ${DIGEST:0:12}"
          git push


  # ============================================================================
  # Summary
  # ============================================================================
  summary:
    name: Pipeline Summary
    needs: [build-and-push, provenance, verify, update-deployment]
    runs-on: self-hosted
    if: always()

    steps:
      - name: Generate summary
        env:
          DIGEST: ${{ needs.build-and-push.outputs.image-digest }}
          IMAGE: ${{ needs.build-and-push.outputs.image-name }}
        run: |
          echo "## SLSA L3 Pipeline Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${IMAGE}" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** ${DIGEST}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY


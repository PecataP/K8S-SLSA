name: SLSA L1 + L2 Pipeline

# This workflow implements SLSA Build Level 1 and Level 2
#
# SLSA Build L1 Requirements:
# - Build process is fully scripted/automated
# - Provenance exists (generated by build platform)
#
# SLSA Build L2 Requirements (Hosted Build Platform):
# - All requirements for Build L1
# - Hosted build service (GitHub Actions)
# - Provenance is generated by the build service
# - Provenance contains build parameters
#
# What we're NOT doing yet (for future):
# - Image signing with Cosign (future step)
# - Kyverno policy enforcement (future step)
# - Wazuh monitoring (future step)
# - SLSA L3 hardened builds (future step)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write        # Push to GHCR

env:
  IMAGE_NAME: ghcr.io/pecatap/python-slsa-web
  PYTHON_VERSION: "3.11"

jobs:
  # ============================================================================
  # SLSA Build Level 1: Scripted Build
  # SLSA Build Level 2: Hosted Build Platform (GitHub Actions)
  # ============================================================================
  build-and-push:
    name: Build and Push (SLSA L1 + L2)
    runs-on: self-hosted
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-name: ${{ env.IMAGE_NAME }}
      image-tag: ${{ steps.meta.outputs.tags }}

    steps:
      # ----- Checkout source code -----
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----- Set up build environment -----
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ----- Authenticate to registry -----
      # Note: We use our own base image from GHCR, eliminating Docker Hub dependency
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ----- Generate image metadata -----
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      # ----- Build and push with PROVENANCE -----
      # This satisfies SLSA L1 (provenance exists) and L2 (generated by build service)
      - name: Build and push container image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./DOCKERFILE
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64
          # IMPORTANT: provenance=true generates SLSA provenance attestation
          # This is stored as an attestation manifest in the registry
          provenance: true
          # SBOM (Software Bill of Materials) - optional but recommended
          sbom: true
          # Build args for transparency
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}

      # ----- Display build information -----
      - name: Display build information
        run: |
          echo "### SLSA L1 + L2 Build Complete âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** ${{ steps.build.outputs.digest }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:** ${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SLSA Compliance Status" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Build L1**: Scripted build with provenance" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Build L2**: Hosted build platform (GitHub Actions)" >> $GITHUB_STEP_SUMMARY
          echo "- â­ï¸  **Build L3**: Not implemented (future step)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What's Generated?" >> $GITHUB_STEP_SUMMARY
          echo "1. Container image pushed to GHCR" >> $GITHUB_STEP_SUMMARY
          echo "2. SLSA provenance attestation (stored with image)" >> $GITHUB_STEP_SUMMARY
          echo "3. SBOM (Software Bill of Materials)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verify Provenance" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Using Docker Buildx imagetools" >> $GITHUB_STEP_SUMMARY
          echo "docker buildx imagetools inspect ${{ env.IMAGE_NAME }}@${{ steps.build.outputs.digest }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Verify Provenance Exists (Optional verification step)
  # ============================================================================
  verify-provenance:
    name: Verify SLSA Provenance Exists
    needs: [build-and-push]
    runs-on: self-hosted

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Inspect image and provenance
        env:
          IMAGE: ${{ needs.build-and-push.outputs.image-name }}
          DIGEST: ${{ needs.build-and-push.outputs.image-digest }}
        run: |
          echo "Inspecting image with provenance..."
          docker buildx imagetools inspect "${IMAGE}@${DIGEST}"

          echo ""
          echo "âœ… Provenance attestation is attached to the image"
          echo "This satisfies SLSA Build L1 (provenance exists) and L2 (generated by build service)"

  # ============================================================================
  # Summary
  # ============================================================================
  summary:
    name: Pipeline Summary
    needs: [build-and-push, verify-provenance]
    runs-on: self-hosted
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## SLSA L1 + L2 Pipeline Complete ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What We Built" >> $GITHUB_STEP_SUMMARY
          echo "- **Application**: Python web server" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ needs.build-and-push.outputs.image-name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest**: ${{ needs.build-and-push.outputs.image-digest }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SLSA Compliance" >> $GITHUB_STEP_SUMMARY
          echo "| Level | Requirement | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **L1** | Scripted build | âœ… Complete |" >> $GITHUB_STEP_SUMMARY
          echo "| **L1** | Provenance exists | âœ… Complete |" >> $GITHUB_STEP_SUMMARY
          echo "| **L2** | Hosted build platform | âœ… Complete (GitHub Actions) |" >> $GITHUB_STEP_SUMMARY
          echo "| **L2** | Provenance by service | âœ… Complete (docker/build-push-action) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps (Future)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Add Cosign signing for image verification" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š Add Wazuh for security monitoring" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ›¡ï¸  Add Kyverno for policy enforcement" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ Implement SLSA L3 (hardened builds)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deploy to Kubernetes" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Update your deployment to use the new image:" >> $GITHUB_STEP_SUMMARY
          echo "kubectl set image deployment/python-slsa-web \\" >> $GITHUB_STEP_SUMMARY
          echo "  python-slsa-web=${{ needs.build-and-push.outputs.image-name }}@${{ needs.build-and-push.outputs.image-digest }} \\" >> $GITHUB_STEP_SUMMARY
          echo "  -n demo" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

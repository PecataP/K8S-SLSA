# Kyverno Policies for SLSA L3

This directory contains Kyverno policies that enforce SLSA Level 3 compliance for container deployments.

## Overview

These policies ensure that:
1. **Images use immutable digests** instead of mutable tags
2. **Images are cryptographically signed** with Cosign
3. **Images have valid SLSA L3 provenance** from slsa-github-generator

## Policies

### 1. `require-image-digest.yaml`

**Purpose**: Enforce that all container images use digest references (sha256) instead of tags.

**What it checks**:
- Images must be referenced as `image@sha256:...`
- Mutable tags like `:latest`, `:v1.0`, etc. are rejected

**Why**: Tags can be overwritten (tag mutation attack). Digests are immutable and cryptographically unique.

**Action**: `Enforce` - Blocks pods that don't use digests

### 2. `verify-image-signature.yaml`

**Purpose**: Verify that container images are signed with Cosign using keyless signing.

**What it checks**:
- Images from `ghcr.io/pecatap/python-slsa-web` must have valid Cosign signatures
- Signature must be from GitHub Actions workflow in the authorized repository
- Uses OIDC keyless signing (no private keys)
- Signature logged in Rekor transparency log

**Why**: Ensures images haven't been tampered with and come from the authorized build pipeline.

**Action**: `Enforce` - Blocks unsigned or invalidly signed images

### 3. `verify-slsa-provenance.yaml`

**Purpose**: Verify that container images have valid SLSA L3 provenance attestations.

**What it checks**:
- Images must have SLSA provenance attestation
- Provenance must be generated by `slsa-github-generator` v2.0.0+
- Provenance must be signed and logged in Rekor
- Builder ID must match the authorized slsa-github-generator workflow
- Build type must be container-based

**Why**: SLSA L3 requires non-falsifiable provenance that proves the build was performed in an isolated, hardened environment.

**Action**: `Enforce` - Blocks images without valid L3 provenance

## Installation

### Prerequisites

1. **Kyverno installed** in your cluster:
   ```bash
   kubectl create -f https://github.com/kyverno/kyverno/releases/download/v1.11.1/install.yaml
   ```

2. **Verify Kyverno is running**:
   ```bash
   kubectl get pods -n kyverno
   kubectl get clusterpolicies
   ```

### Apply Policies

```bash
# Apply all policies
kubectl apply -f k8s/kyverno-policies/

# Verify policies are active
kubectl get clusterpolicies

# Check policy status
kubectl get clusterpolicy require-image-digest -o yaml
kubectl get clusterpolicy verify-image-signature -o yaml
kubectl get clusterpolicy verify-slsa-provenance -o yaml
```

## Testing

### Test 1: Deploy Unsigned Image (Should Fail)

```bash
# Try to deploy nginx (not signed)
kubectl run test-unsigned --image=nginx:latest -n demo

# Expected result: Blocked by Kyverno
# Error message will indicate signature verification failed
```

### Test 2: Deploy Image with Tag (Should Fail)

```bash
# Try to deploy with tag instead of digest
kubectl run test-tag --image=ghcr.io/pecatap/python-slsa-web:latest -n demo

# Expected result: Blocked by Kyverno
# Error message: "Images must use digest references"
```

### Test 3: Deploy Valid SLSA L3 Image (Should Succeed)

```bash
# Deploy your signed image with digest
kubectl apply -f k8s/deployment.yaml

# Expected result: Deployment succeeds
# Kyverno verifies signature and provenance automatically
```

## Policy Modes

Kyverno policies can run in two modes:

### Audit Mode (Recommended for Testing)

```yaml
spec:
  validationFailureAction: Audit
```

- Violations are logged but not blocked
- Use this when first implementing policies
- Check violations: `kubectl get policyreport -A`

### Enforce Mode (Production)

```yaml
spec:
  validationFailureAction: Enforce
```

- Violations are blocked
- Pods that don't meet requirements cannot be created
- Current configuration (production-ready)

## Switching to Audit Mode

If you want to test without blocking deployments:

```bash
# Edit each policy
kubectl edit clusterpolicy require-image-digest
kubectl edit clusterpolicy verify-image-signature
kubectl edit clusterpolicy verify-slsa-provenance

# Change: validationFailureAction: Enforce
# To:     validationFailureAction: Audit
```

## Monitoring Policy Violations

### View Policy Reports

```bash
# View all policy reports
kubectl get policyreport -A

# View violations in demo namespace
kubectl get policyreport -n demo -o yaml

# Get detailed report
kubectl describe policyreport -n demo
```

### View Kyverno Logs

```bash
# View admission controller logs
kubectl logs -n kyverno -l app.kubernetes.io/component=admission-controller -f

# View background controller logs
kubectl logs -n kyverno -l app.kubernetes.io/component=background-controller -f
```

## Troubleshooting

### Issue: All pods are being blocked

**Possible causes**:
1. Images are using tags instead of digests
2. Images are not signed with Cosign
3. Images don't have SLSA L3 provenance

**Solutions**:
```bash
# Check what's failing
kubectl describe clusterpolicy verify-image-signature

# View admission controller logs
kubectl logs -n kyverno -l app.kubernetes.io/component=admission-controller --tail=50

# Switch to Audit mode temporarily
kubectl patch clusterpolicy verify-image-signature --type merge -p '{"spec":{"validationFailureAction":"Audit"}}'
```

### Issue: Signature verification timing out

**Solution**: Increase webhook timeout:
```yaml
spec:
  webhookTimeoutSeconds: 30  # Increase if needed
```

### Issue: Policy not applying to pods

**Check**:
```bash
# Verify policy is active
kubectl get clusterpolicy

# Check policy status
kubectl get clusterpolicy verify-image-signature -o jsonpath='{.status}'

# Verify namespace is not excluded
kubectl get clusterpolicy verify-image-signature -o yaml | grep -A5 match
```

## Verification Commands

After deployment, verify everything worked:

```bash
# Get the image digest from your running pod
DIGEST=$(kubectl get pod -n demo -l app=python-slsa-web -o jsonpath='{.items[0].spec.containers[0].image}' | cut -d'@' -f2)

# Verify signature locally
cosign verify \
  --certificate-identity-regexp='https://github.com/PecataP/K8S-SLSA/.*' \
  --certificate-oidc-issuer='https://token.actions.githubusercontent.com' \
  ghcr.io/pecatap/python-slsa-web@${DIGEST}

# Verify SLSA L3 provenance locally
slsa-verifier verify-image \
  --source-uri github.com/PecataP/K8S-SLSA \
  ghcr.io/pecatap/python-slsa-web@${DIGEST}
```

## Policy Customization

### Allow Additional Registries

Edit `verify-image-signature.yaml`:
```yaml
imageReferences:
  - "ghcr.io/pecatap/python-slsa-web*"
  - "ghcr.io/myorg/another-app*"  # Add more
```

### Exclude Specific Namespaces

Add exclusions to policies:
```yaml
match:
  any:
    - resources:
        kinds:
          - Pod
        namespaces:
          - demo
exclude:
  any:
    - resources:
        namespaces:
          - kube-system  # Exclude system namespaces
          - kyverno
```

### Adjust Provenance Version

If using a different slsa-github-generator version:
```yaml
subject: "https://github.com/slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@refs/tags/v2.1.0"
```

## Resources

- [Kyverno Documentation](https://kyverno.io/docs/)
- [Kyverno Policy Library](https://kyverno.io/policies/)
- [Cosign Verification](https://docs.sigstore.dev/verifying/verify/)
- [SLSA Specification](https://slsa.dev/spec/v1.0/)
- [slsa-github-generator](https://github.com/slsa-framework/slsa-github-generator)

## Support

If policies are blocking legitimate deployments:

1. Check the Kyverno logs for details
2. Verify your image is properly signed and has provenance
3. Switch to Audit mode temporarily to investigate
4. Ensure the OIDC identity in the policy matches your workflow

For issues with signature verification, see: https://docs.sigstore.dev/cosign/overview/

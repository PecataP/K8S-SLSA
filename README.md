# Kubernetes SLSA L1 + L2 Pipeline

A clean, focused implementation of **SLSA Build Level 1 and Level 2** for a Python web application deployed to Kubernetes.

## ğŸ¯ Project Overview

This project demonstrates **SLSA Build Levels 1 and 2** without the complexity of additional security tools. The focus is on understanding and implementing the core SLSA requirements:

- âœ… **SLSA Build L1**: Scripted build with provenance generation
- âœ… **SLSA Build L2**: Hosted build platform (GitHub Actions)
- ğŸ“¦ **Python Application**: Simple HTTP server
- ğŸš€ **Kubernetes**: Basic deployment to your K8s cluster

**What's NOT included** (for future iterations):
- âŒ Cosign signing (next step)
- âŒ Kyverno policies (next step)
- âŒ Wazuh monitoring (next step)
- âŒ SLSA Build L3 (future)

## ğŸ“š Understanding SLSA L1 and L2

### SLSA Build Level 1 Requirements

From [SLSA Specification](https://slsa.dev/spec/v1.1/levels):

1. **Scripted build**: Build process is fully automated (no manual steps)
2. **Provenance exists**: Build platform generates provenance about how the artifact was built

**How we achieve this:**
- GitHub Actions workflow is fully automated
- `docker/build-push-action@v6` with `provenance: true` generates SLSA provenance
- Provenance is attached to the container image in the registry

### SLSA Build Level 2 Requirements

From [SLSA Specification](https://slsa.dev/spec/v1.1/levels):

1. **All Build L1 requirements** âœ…
2. **Hosted build platform**: Build service that generates provenance
3. **Provenance authenticity**: Provenance is generated by the build service (not user-controlled)

**How we achieve this:**
- GitHub Actions is the hosted build platform (not your local machine)
- `docker/build-push-action` generates provenance automatically
- Provenance includes build parameters, builder identity, and materials

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         GitHub Actions (Self-Hosted)        â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. Checkout Code                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚               â†“                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  2. Build Container Image          â”‚   â”‚
â”‚  â”‚     - Multi-stage build            â”‚   â”‚
â”‚  â”‚     - Generate SLSA provenance     â”‚   â”‚
â”‚  â”‚     - Generate SBOM                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚               â†“                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  3. Push to GHCR                   â”‚   â”‚
â”‚  â”‚     - Image + Provenance           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚               â†“                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  4. Verify Provenance Exists       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Kubernetes Cluster (Your Setup)        â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚     Python Web Application         â”‚   â”‚
â”‚  â”‚     - 2 replicas                   â”‚   â”‚
â”‚  â”‚     - NodePort 30080               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ Prerequisites

- âœ… Kubernetes cluster (you have this)
- âœ… GHCR configured in K8s (you have this)
- âœ… Self-hosted GitHub Actions runner
- âœ… Docker on the runner
- âœ… Git

## ğŸš€ Quick Start

### Step 1: Update Configuration

Edit `.github/workflows/slsa-l1-l2.yml` and replace:
```yaml
IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/python-slsa-web
```

Edit `k8s/deployment.yaml` line 25 and replace:
```yaml
image: ghcr.io/YOUR_USERNAME/python-slsa-web:latest
```

### Step 2: Create Kubernetes Namespace

```bash
kubectl apply -f k8s/namespace.yaml
```

### Step 3: Create GHCR Pull Secret (if private repo)

```bash
kubectl create secret docker-registry ghcr-creds \
  --docker-server=ghcr.io \
  --docker-username=YOUR_GITHUB_USERNAME \
  --docker-password=YOUR_GITHUB_PAT \
  --namespace=demo
```

### Step 4: Trigger CI Pipeline

```bash
git add .
git commit -m "Setup SLSA L1+L2 pipeline"
git push origin main
```

Watch the workflow at: `https://github.com/YOUR_USERNAME/K8S-SLSA/actions`

### Step 5: Deploy to Kubernetes

After the pipeline completes:

```bash
# Update deployment with the new image digest (from CI output)
kubectl apply -f k8s/

# Check deployment
kubectl get pods -n demo
kubectl get svc -n demo
```

### Step 6: Access Your Application

```bash
# Get node IP
kubectl get nodes -o wide

# Access application
curl http://<NODE_IP>:30080

# Or use port-forward
kubectl port-forward -n demo svc/python-slsa-web 8080:80
curl http://localhost:8080
```

## ğŸ“Š What Gets Generated

When the CI pipeline runs, it generates:

1. **Container Image**: Pushed to GHCR
2. **SLSA Provenance**: Attestation manifest attached to the image
3. **SBOM**: Software Bill of Materials

### Viewing the Provenance

```bash
# Inspect image with provenance
docker buildx imagetools inspect ghcr.io/YOUR_USERNAME/python-slsa-web:latest

# You should see:
# - Image manifest
# - Provenance attestation manifest
# - SBOM attestation manifest
```

The provenance includes:
- Build parameters
- Source repository
- Commit SHA
- Builder identity (GitHub Actions)
- Materials (Dockerfile, source code)

## ğŸ” Understanding the CI Workflow

### Job 1: `build-and-push`

```yaml
- uses: docker/build-push-action@v6
  with:
    provenance: true  # â† This generates SLSA provenance
    sbom: true        # â† This generates SBOM
```

This single action:
- âœ… Satisfies SLSA L1 (provenance exists)
- âœ… Satisfies SLSA L2 (generated by hosted build service)

### Job 2: `verify-provenance`

```bash
docker buildx imagetools inspect IMAGE@DIGEST
```

This verifies:
- Provenance attestation was attached
- Image has the expected metadata

### Job 3: `summary`

Generates a nice summary showing:
- What was built
- SLSA compliance status
- Next deployment steps

## ğŸ“‹ SLSA L1 vs L2 Comparison

| Requirement | L1 | L2 |
|-------------|----|----|
| Automated build | âœ… | âœ… |
| Provenance exists | âœ… | âœ… |
| Hosted build platform | âŒ | âœ… |
| Provenance by service | âŒ | âœ… |
| Provenance includes builder | âŒ | âœ… |

**Key Difference**: L2 requires the build to happen on a hosted platform (not your laptop), and the provenance must be generated by that platform (not manually).

## ğŸ§ª Testing SLSA Compliance

### Test 1: Verify Provenance Exists

```bash
# Set your image
IMAGE="ghcr.io/YOUR_USERNAME/python-slsa-web:latest"

# Inspect with Docker
docker buildx imagetools inspect $IMAGE

# Look for:
# - MediaType: application/vnd.in-toto+json (provenance)
# - Subject: your image digest
```

### Test 2: Check Build Was Automated

Look at GitHub Actions logs:
1. No manual steps required
2. Build triggered automatically on push
3. All steps scripted

### Test 3: Verify Hosted Build

Check that:
- Build ran on GitHub Actions (not locally)
- Provenance includes `builder.id` pointing to GitHub Actions
- Build environment is ephemeral (fresh each time)

## ğŸ“ˆ Monitoring Your Pipeline

### GitHub Actions

```bash
# View workflow runs
gh run list --workflow=slsa-l1-l2.yml

# View specific run
gh run view RUN_ID
```

### Kubernetes

```bash
# View logs
kubectl logs -n demo -l app=python-slsa-web -f

# Check status
kubectl get all -n demo

# Describe pods
kubectl describe pod -n demo
```

## ğŸ› Troubleshooting

### Issue: Self-hosted runner not picking up jobs

**Check:**
```bash
# On your runner machine
cd actions-runner
./run.sh

# Ensure it shows "Listening for Jobs"
```

### Issue: ImagePullBackOff in Kubernetes

**Solution:**
```bash
# Check if secret exists
kubectl get secret ghcr-creds -n demo

# Recreate if needed (use GitHub PAT with packages:read)
kubectl create secret docker-registry ghcr-creds \
  --docker-server=ghcr.io \
  --docker-username=YOUR_USERNAME \
  --docker-password=YOUR_PAT \
  -n demo
```

### Issue: Provenance not showing up

**Check:**
```bash
# Make sure provenance: true is in the workflow
grep "provenance:" .github/workflows/slsa-l1-l2.yml

# Should output: provenance: true
```

## ğŸ“– Next Steps

Now that you have SLSA L1 + L2 working, you can add:

1. **Cosign Signing**
   - Sign images with keyless signing
   - Verify signatures in K8s

2. **Wazuh Monitoring**
   - Runtime security monitoring
   - Vulnerability detection

3. **Kyverno Policies**
   - Enforce signed images only
   - Policy-based admission control

4. **SLSA Build L3**
   - Use `slsa-github-generator`
   - Hardened build platform
   - Non-falsifiable provenance

## ğŸ“š Resources

- [SLSA Specification](https://slsa.dev/spec/v1.1/)
- [SLSA Build Levels](https://slsa.dev/spec/v1.1/levels)
- [Docker Build Push Action](https://github.com/docker/build-push-action)
- [Understanding Provenance](https://docs.docker.com/build/attestations/slsa-provenance/)

## ğŸ¤ Contributing

This is a learning project! Feel free to:
- Open issues with questions
- Submit PRs with improvements
- Share your learnings

## ğŸ“„ License

MIT License - See LICENSE file

---

**Current Status**: âœ… SLSA Build L1 + L2 Complete

**Next Goal**: ğŸ” Add Cosign Signing
